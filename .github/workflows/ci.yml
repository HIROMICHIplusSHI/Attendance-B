name: CI/CD Pipeline ğŸš€

on:
  push:
    branches: [ main, develop, 'feature/*' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ (Ruby ${{ matrix.ruby-version }})
    runs-on: ubuntu-latest

    strategy:
      matrix:
        ruby-version: ['3.2.4']

    services:
      mysql:
        image: mysql:8.0.35
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: attendance_app_test
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        ports:
          - 3306:3306

    steps:
    - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: ğŸ’ Ruby ${{ matrix.ruby-version }} ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ matrix.ruby-version }}
        bundler-cache: true

    - name: ğŸ“¦ ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        sudo apt-get update
        sudo apt-get install -y mysql-client libmysqlclient-dev

    - name: ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      env:
        RAILS_ENV: test
        DATABASE_URL: mysql2://root:password@127.0.0.1:3306/attendance_app_test
      run: |
        bundle exec rails db:create
        bundle exec rails db:migrate

    - name: ğŸ” RuboCop (ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯)
      run: bundle exec rubocop

    - name: ğŸ§ª RSpec (ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ)
      env:
        RAILS_ENV: test
        DATABASE_URL: mysql2://root:password@127.0.0.1:3306/attendance_app_test
      run: bundle exec rspec

  build_status:
    name: ğŸ“Š ãƒ“ãƒ«ãƒ‰çŠ¶æ³ç¢ºèª
    runs-on: ubuntu-latest
    needs: test
    if: always()

    steps:
    - name: ğŸ‰ æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      if: needs.test.result == 'success'
      run: |
        echo "ğŸ‰ ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼"
        echo "âœ… CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Œäº†"

    - name: âŒ å¤±æ•—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      if: needs.test.result != 'success'
      run: |
        echo "âŒ ãƒ†ã‚¹ãƒˆã¾ãŸã¯ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ã§å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
        echo "ğŸ”§ ä¿®æ­£ãŒå¿…è¦ã§ã™"
        exit 1