name: CI/CD Pipeline ğŸš€

on:
  push:
    branches: [ main, develop, 'feature/*' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ (Ruby ${{ matrix.ruby-version }})
    runs-on: ubuntu-latest

    strategy:
      matrix:
        ruby-version: ['3.2.4']

    services:
      mysql:
        image: mysql:8.0.35
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: attendance_app_test
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=10
          --health-start-period=30s
        ports:
          - 3306:3306

    steps:
    - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: ğŸ’ Ruby ${{ matrix.ruby-version }} ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ matrix.ruby-version }}
        bundler-cache: true

    - name: ğŸ“¦ ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        sudo apt-get update
        sudo apt-get install -y mysql-client libmysqlclient-dev

    - name: ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      env:
        RAILS_ENV: test
        DB_HOST: 127.0.0.1
      run: |
        # MySQLæ¥ç¶šå¾…æ©Ÿ
        for i in {1..30}; do
          if mysqladmin ping -h127.0.0.1 -uroot -ppassword --silent; then
            echo "MySQL is ready!"
            break
          fi
          echo "Waiting for MySQL... ($i/30)"
          sleep 2
        done

        bundle exec rails db:create
        bundle exec rails db:migrate

    - name: ğŸ” RuboCop (ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯)
      run: bundle exec rubocop

    - name: ğŸ§ª RSpec (ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ + ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®š)
      env:
        RAILS_ENV: test
        DB_HOST: 127.0.0.1
      run: bundle exec rspec

    - name: ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç¢ºèª
      run: |
        echo "ğŸ“ˆ SimpleCovã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèªä¸­..."
        if [ -f coverage/.resultset.json ]; then
          echo "âœ… ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ‡ãƒ¼ã‚¿ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ"
          ls -la coverage/
        else
          echo "âš ï¸ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        fi

  deploy:
    name: ğŸš€ æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && needs.test.result == 'success'

    steps:
    - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: ğŸš€ Renderãƒ‡ãƒ—ãƒ­ã‚¤é€šçŸ¥
      run: |
        echo "ğŸš€ mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã‚’æ¤œçŸ¥ã—ã¾ã—ãŸ"
        echo "ğŸ“¡ RenderãŒè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹ã—ã¾ã™"
        echo "ğŸ”— ãƒ‡ãƒ—ãƒ­ã‚¤çŠ¶æ³ã¯Renderãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ç¢ºèªã§ãã¾ã™"

    - name: â³ ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†å¾…æ©Ÿ
      run: |
        echo "â³ Renderã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã‚’ãŠå¾…ã¡ãã ã•ã„..."
        echo "âœ… é€šå¸¸2-3åˆ†ã§ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã™"

  build_status:
    name: ğŸ“Š ãƒ“ãƒ«ãƒ‰çŠ¶æ³ç¢ºèª
    runs-on: ubuntu-latest
    needs: test
    if: always()

    steps:
    - name: ğŸ‰ æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      if: needs.test.result == 'success'
      run: |
        echo "ğŸ‰ ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼"
        if [[ "${{ github.ref }}" == "refs/heads/main" && "${{ github.event_name }}" == "push" ]]; then
          echo "ğŸš€ æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ"
          echo "ğŸ“¡ Renderãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ãƒ‡ãƒ—ãƒ­ã‚¤çŠ¶æ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
        fi
        echo "âœ… CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Œäº†"

    - name: âŒ å¤±æ•—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      if: needs.test.result != 'success'
      run: |
        echo "âŒ ãƒ†ã‚¹ãƒˆã¾ãŸã¯ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ã§å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
        echo "ğŸ”§ ä¿®æ­£ãŒå¿…è¦ã§ã™"
        exit 1