<div class="modal-header">
  <h4 class="modal-title">勤怠変更申請の承認</h4>
  <button type="button" class="close" data-action="modal#close">&times;</button>
</div>

<% if flash[:notice] %>
  <div class="alert alert-success" style="margin: 15px;">
    <%= flash[:notice] %>
  </div>
<% end %>

<% if flash[:alert] %>
  <div class="alert alert-danger" style="margin: 15px;">
    <%= flash[:alert] %>
  </div>
<% end %>

<%= form_with url: bulk_update_attendance_change_approvals_path, method: :patch,
              local: true,
              remote: true,
              html: {
                data: {
                  confirm: "true",
                  confirm_message: "変更内容を送信してよろしいですか？"
                }
              } do |f| %>
  <div class="modal-body">
    <% if @requests.any? %>
      <% @requests.group_by(&:requester).each do |requester, requests| %>
        <h5 style="margin-top: 20px; margin-bottom: 10px; padding: 10px; background-color: #f5f5f5; border-left: 4px solid #337ab7;">
          【<%= requester.name %>さんからの申請】
        </h5>
        <table class="table table-bordered table-striped" style="margin-bottom: 30px;">
          <thead>
            <tr>
              <th>日付</th>
              <th>変更前</th>
              <th>変更後</th>
              <th>変更理由</th>
              <th>承認/否認</th>
              <th>変更</th>
              <th>勤怠確認</th>
            </tr>
          </thead>
          <tbody>
            <% requests.each do |request| %>
              <tr>
                <td><%= l(request.attendance.worked_on, format: :short) %></td>
                <td>
                  <%= request.original_started_at&.strftime("%H:%M") %> -
                  <%= request.original_finished_at&.strftime("%H:%M") %>
                </td>
                <td>
                  <%= request.requested_started_at&.strftime("%H:%M") %> -
                  <%= request.requested_finished_at&.strftime("%H:%M") %>
                </td>
                <td><%= request.change_reason %></td>
                <td>
                  <%= f.select "requests[#{request.id}][status]",
                      options_for_select([
                        ['申請中', 'pending'],
                        ['承認', 'approved'],
                        ['否認', 'rejected']
                      ], request.status),
                      {},
                      class: "form-control" %>
                </td>
                <td class="text-center">
                  <%= f.check_box "requests[#{request.id}][selected]", {}, '1', '0' %>
                </td>
                <td class="text-center">
                  <%= link_to "確認",
                      user_path(request.requester, date: request.attendance.worked_on.beginning_of_month),
                      target: "_blank",
                      rel: "noopener noreferrer",
                      class: "btn btn-info btn-sm" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% end %>
    <% else %>
      <p class="text-center text-muted">承認待ちの申請はありません</p>
    <% end %>
  </div>

  <div class="modal-footer">
    <button type="button" class="btn btn-default" data-action="modal#close">キャンセル</button>
    <% if @requests.any? %>
      <%= f.submit "変更を送信する", class: "btn btn-primary" %>
    <% end %>
  </div>
<% end %>
