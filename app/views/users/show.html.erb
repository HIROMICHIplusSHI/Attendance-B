<% provide(:title, @user.name) %>
<div>
  <!-- クローン元完全再現：2行×4列ユーザー情報テーブル -->
  <table class="table table-bordered table-condensed user-table">
    <tr>
      <td>
        <% if current_user?(@user) %>
          <%= link_to "⇦", user_path(date: @first_day.prev_month), class: "btn btn-primary btn-sm", style: "margin-right: 10px;" %>
        <% end %>
        <%= @first_day.present? ? l(@first_day, format: :middle) : "日付取得エラー" %> 時間管理表
        <% if current_user?(@user) %>
          <%= link_to "⇨", user_path(date: @first_day.next_month), class: "btn btn-primary btn-sm", style: "margin-left: 10px;" %>
        <% end %>
      </td>
      <td>指定勤務時間：<%= format_basic_info(@user.work_time) %></td>
      <td>基本時間：<%= format_basic_info(@user.basic_time) %></td>
      <td>月初日：<%= @first_day.present? ? l(@first_day, format: :short) : "なし" %></td>
    </tr>

    <tr>
      <td>所属：<%= @user.department.present? ? @user.department : "未所属" %></td>
      <td>名前：<%= @user.name %></td>
      <td>出勤日数：<%= @worked_sum %>日</td>
      <td>月末日：<%= @last_day.present? ? l(@last_day, format: :short) : "なし" %></td>
    </tr>
  </table>
</div>

<!-- マネージャー向けお知らせセクション -->
<% if current_user.manager? && current_user?(@user) %>
  <div class="approval-notifications" style="margin-top: 20px;" data-controller="modal">
    <h4>承認待ち申請</h4>

    <div class="notification-item">
      <%= link_to monthly_approvals_path, data: { action: "modal#open" }, class: "notification-link" do %>
        【所属長承認申請のお知らせ】
        <% if monthly_approvals_count > 0 %>
          <span class="notification-badge"><%= monthly_approvals_count %>件</span>
        <% end %>
      <% end %>
    </div>

    <div class="notification-item">
      <%= link_to attendance_change_approvals_path, data: { action: "modal#open" }, class: "notification-link" do %>
        【勤怠変更申請のお知らせ】
        <% if attendance_change_requests_count > 0 %>
          <span class="notification-badge"><%= attendance_change_requests_count %>件</span>
        <% end %>
      <% end %>
    </div>

    <div class="notification-item">
      <%= link_to overtime_approvals_path, data: { action: "modal#open" }, class: "notification-link" do %>
        【残業申請のお知らせ】
        <% if overtime_requests_count > 0 %>
          <span class="notification-badge"><%= overtime_requests_count %>件</span>
        <% end %>
      <% end %>
    </div>

    <!-- モーダルコンテナ -->
    <div data-modal-target="container"
         class="modal"
         style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1050; background-color: rgba(0,0,0,0.3); overflow-y: auto;"
         data-action="click->modal#backgroundClick">
      <div class="modal-dialog" style="position: relative; width: auto; margin: 50px auto; max-width: 800px;">
        <div data-modal-target="content" class="modal-content">
          <!-- モーダルコンテンツはJavaScriptで挿入 -->
        </div>
      </div>
    </div>
  </div>
<% end %>

<!-- 1ヶ月の勤怠編集ボタン（ユーザー情報テーブル下） -->
<% if current_user?(@user) %>
  <div class="btn-users-show">
    <%= link_to "1ヶ月の勤怠編集へ", edit_one_month_user_attendances_path(@user, date: @first_day), class: "btn btn-primary", data: { turbo: false } %>
    <%= link_to "CSVを出力", export_csv_user_path(@user, date: @first_day), class: "btn btn-primary", data: { turbo: false }, onclick: "return confirm('CSVファイルをダウンロードしますか？')" %>
  </div>

  <!-- 勤怠ログモーダル（Stimulus版） -->
  <div data-controller="modal">
    <%= link_to "勤怠修正ログ（承認済み）", attendance_log_user_path(@user, date: @first_day),
        class: "btn btn-primary",
        data: { action: "modal#open" } %>

    <div data-modal-target="container"
         class="modal"
         style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1050; background-color: rgba(0,0,0,0.3); overflow-y: auto;"
         data-action="click->modal#backgroundClick">
      <div class="modal-dialog" style="position: relative; width: auto; margin: 50px auto; max-width: 800px;">
        <div data-modal-target="content" class="modal-content">
          <!-- モーダルコンテンツはJavaScriptで挿入 -->
        </div>
      </div>
    </div>
  </div>
<% end %>

<!-- 基本情報編集モーダル（Stimulus版） -->
<% if current_user?(@user) %>
  <div data-controller="modal">
    <% if current_user.admin? %>
      <%= link_to "基本情報編集", edit_basic_info_user_path(@user),
          class: "btn btn-primary",
          data: { action: "modal#open" } %>
    <% end %>
  <div data-modal-target="container" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1050; background-color: rgba(0,0,0,0.3); overflow-y: auto;" data-action="click->modal#backgroundClick">
    <div class="modal-dialog" style="position: relative; width: auto; margin: 50px auto; max-width: 600px;">
      <div data-modal-target="content" class="modal-content">
        <!-- モーダルコンテンツはJavaScriptで挿入 -->
      </div>
    </div>
  </div>
  </div>
<% end %>

<!-- 統合申請モーダル（Stimulus版） -->
<div data-controller="modal">
  <!-- クローン元完全再現：7列シンプル勤怠テーブル -->
  <table class="table table-bordered table-condensed table-hover text-center" id="table-attendances">
    <thead>
      <!-- 1段目：大グループ -->
      <tr>
        <th rowspan="3" class="text-center">残業申請</th>
        <th rowspan="3" class="text-center">日付</th>
        <th rowspan="3" class="text-center">曜日</th>
        <th colspan="7" class="text-center">【実績】</th>
        <th colspan="5" class="text-center">所定外勤務</th>
      </tr>
      <!-- 2段目：中グループ -->
      <tr>
        <th colspan="3" class="text-center">出社</th>
        <th colspan="2" class="text-center">退社</th>
        <th rowspan="2" class="text-center">在社時間</th>
        <th rowspan="2" class="text-center">備考</th>
        <th colspan="2" class="text-center">終了予定時間</th>
        <th rowspan="2" class="text-center">時間外時間</th>
        <th rowspan="2" class="text-center">業務処理内容</th>
        <th rowspan="2" class="text-center">指示者確認印</th>
      </tr>
      <!-- 3段目：詳細カラム -->
      <tr>
        <th class="text-center" style="width: 50px;">時</th>
        <th class="text-center" style="width: 50px;">分</th>
        <th class="text-center" style="width: 100px;">勤怠登録</th>
        <th class="text-center" style="width: 50px;">時</th>
        <th class="text-center" style="width: 50px;">分</th>
        <th class="text-center" style="width: 50px;">時</th>
        <th class="text-center" style="width: 50px;">分</th>
      </tr>
    </thead>
    <tbody>
      <% @attendances.each do |day| %>
      <% overtime = @overtime_requests&.dig(day.worked_on) %>
      <tr>
        <!-- 残業申請 -->
        <td class="text-center">
          <% if current_user?(@user) %>
            <%= link_to "残業申請", new_user_attendance_application_request_path(@user, day),
                class: "btn btn-primary btn-sm application-request-btn",
                data: { attendance_id: day.id, action: "modal#open" } %>
          <% end %>
        </td>

        <!-- 日付 -->
        <td class="text-center"><%= l(day.worked_on, format: :short) %></td>

        <!-- 曜日 -->
        <td class="text-center
          <%= 'text-primary' if day.worked_on.wday == 6 %>
          <%= 'text-danger' if day.worked_on.wday == 0 %>">
          <%= ApplicationController::DAYS_OF_THE_WEEK[day.worked_on.wday] %>
        </td>

        <!-- 【実績】出社：時 -->
        <td class="text-center">
          <%= day.started_at&.strftime("%H") %>
        </td>

        <!-- 【実績】出社：分 -->
        <td class="text-center">
          <%= day.started_at&.strftime("%M") %>
        </td>

        <!-- 【実績】出社：勤怠登録 -->
        <td class="text-center">
          <% if current_user?(@user) %>
            <% if btn_text = attendance_state(day) %>
              <%= button_to "#{btn_text}登録", user_attendance_path(@user, day),
                method: :patch,
                params: { attendance: { "#{btn_text == '出勤' ? 'started_at' : 'finished_at'}" => Time.current.strftime("%H:%M") } },
                class: "btn btn-primary btn-attendance",
                form_class: "d-inline" %>
            <% end %>
          <% end %>
        </td>

        <!-- 【実績】退社：時 -->
        <td class="text-center">
          <%= day.finished_at&.strftime("%H") %>
        </td>

        <!-- 【実績】退社：分 -->
        <td class="text-center">
          <%= day.finished_at&.strftime("%M") %>
        </td>

        <!-- 【実績】在社時間 -->
        <td class="text-center">
          <% if day.started_at.present? && day.finished_at.present? %>
            <%= working_times(day.started_at, day.finished_at) %>
          <% end %>
        </td>

        <!-- 【実績】備考 -->
        <td class="text-center"><%= day.note %></td>

        <!-- 所定外勤務：終了予定時間：時 -->
        <td class="text-center">
          <%= overtime&.estimated_end_time&.strftime("%H") %>
        </td>

        <!-- 所定外勤務：終了予定時間：分 -->
        <td class="text-center">
          <%= overtime&.estimated_end_time&.strftime("%M") %>
        </td>

        <!-- 所定外勤務：時間外時間 -->
        <td class="text-center">
          <% if overtime&.rejected? %>
            0.00
          <% elsif day.finished_at.present? && overtime&.estimated_end_time.present? && overtime&.approved? %>
            <!-- デバッグ: <%= "finished_at: #{day.finished_at}, worked_on: #{day.worked_on}, estimated: #{overtime.estimated_end_time}" %> -->
            <% finished_time = Time.zone.parse("#{day.worked_on} #{day.finished_at.strftime('%H:%M')}") %>
            <% estimated_time = Time.zone.parse("#{day.worked_on} #{overtime.estimated_end_time.strftime('%H:%M')}") %>
            <% overtime_hours = ((estimated_time - finished_time) / 3600.0).round(2) %>
            <%= format("%.2f", [overtime_hours, 0].max) %>
          <% end %>
        </td>

        <!-- 所定外勤務：業務処理内容 -->
        <td class="text-center"><%= overtime&.business_content %></td>

        <!-- 所定外勤務：指示者確認印 -->
        <td class="text-center">
          <% if overtime.present? %>
            <div>
              <%= overtime.approver.name %>
              <% case overtime.status %>
              <% when 'approved' %>
                <span class="badge bg-success">承認済</span>
              <% when 'pending' %>
                <span class="badge bg-warning">申請中</span>
              <% when 'rejected' %>
                <span class="badge bg-danger">否認</span>
              <% end %>
            </div>
          <% end %>
        </td>
      </tr>
      <% end %>
    </tbody>
    <!-- クローン元完全再現：統計フッター -->
    <tfoot>
      <tr>
        <td colspan="3" class="text-center">累計日数</td>
        <td colspan="4" class="text-center">総合勤務時間</td>
        <td colspan="3" class="text-center">累計在社時間</td>
        <td colspan="3" class="text-center">累計残業時間</td>
        <td colspan="2" class="text-center">所属長承認</td>
      </tr>
      <tr>
        <td colspan="3" class="text-center"><%= @attendances.count { |day| day.started_at.present? } %></td>
        <td colspan="4" class="text-center"><%= format_basic_info(@user.work_time).to_f * @worked_sum %></td>
        <td colspan="3" class="text-center">
          <% @total_working_times = @total_working_times.to_f %>
          <% @attendances.each do |day| %>
            <% if day.started_at.present? && day.finished_at.present? %>
              <% @total_working_times += working_times(day.started_at, day.finished_at).to_f %>
            <% end %>
          <% end %>
          <%= format("%.2f", @total_working_times) %>
        </td>
        <td colspan="3" class="text-center">
          <% total_overtime = 0.0 %>
          <% @overtime_requests&.each do |date, overtime| %>
            <% day = @attendances.find { |a| a.worked_on == date } %>
            <% if overtime&.approved? && day&.finished_at.present? && overtime&.estimated_end_time.present? %>
              <% finished_time = Time.zone.parse("#{day.worked_on} #{day.finished_at.strftime('%H:%M')}") %>
              <% estimated_time = Time.zone.parse("#{day.worked_on} #{overtime.estimated_end_time.strftime('%H:%M')}") %>
              <% overtime_hours = ((estimated_time - finished_time) / 3600.0) %>
              <% total_overtime += [overtime_hours, 0].max %>
            <% end %>
          <% end %>
          <%= format("%.2f", total_overtime) %>
        </td>
        <td colspan="2" class="text-center">
          <% approval = MonthlyApproval.find_by(user: @user, target_month: @first_day) %>
          <% if approval.present? %>
            <div>
              <%= approval.approver.name %>
              <% case approval.status %>
              <% when 'approved' %>
                <span class="badge bg-success">承認済</span>
              <% when 'pending' %>
                <span class="badge bg-warning">申請中</span>
              <% when 'rejected' %>
                <span class="badge bg-danger">否認</span>
              <% end %>
            </div>
          <% else %>
            <span class="text-muted">未申請</span>
          <% end %>
          <% if current_user?(@user) %>
            <div style="margin-top: 10px;">
              <%= form_with model: MonthlyApproval.new, url: user_monthly_approvals_path(@user), local: true, html: { style: "display: flex; flex-direction: column; gap: 8px; align-items: center;" } do |f| %>
                <%= f.hidden_field :target_month, value: @first_day %>
                <%= f.select :approver_id,
                    options_from_collection_for_select(
                      User.manager.where.not(id: @user.id).order(:name),
                      :id,
                      :name,
                      @user.manager_id
                    ),
                    { prompt: "承認者を選択" },
                    class: "form-select", style: "width: 200px;" %>
                <%= f.submit approval.present? ? "再申請" : "申請", class: "btn btn-primary", style: "width: 200px;",
                    data: { confirm: "承認者に勤怠を#{approval.present? ? '再' : ''}申請します。よろしいですか？" } %>
              <% end %>
            </div>
          <% end %>
        </td>
      </tr>
    </tfoot>
  </table>

  <!-- モーダルコンテナ -->
  <div data-modal-target="container"
       class="modal"
       style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1050; background-color: rgba(0,0,0,0.3); overflow-y: auto;"
       data-action="click->modal#backgroundClick">
    <div class="modal-dialog" style="position: relative; width: auto; margin: 50px auto; max-width: 800px;">
      <div data-modal-target="content" class="modal-content">
        <!-- モーダルコンテンツはJavaScriptで挿入 -->
      </div>
    </div>
  </div>
</div>


<!-- 土日色分けスタイル -->
<style>
/* 土曜日のスタイル（青系） */
#table-attendances tr:has(.text-primary) {
  background-color: #f0f8ff;
}

/* 日曜日のスタイル（赤系） */
#table-attendances tr:has(.text-danger) {
  background-color: #fff5f5;
}
</style>
